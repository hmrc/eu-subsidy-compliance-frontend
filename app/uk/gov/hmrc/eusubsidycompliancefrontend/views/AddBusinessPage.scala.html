@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.eusubsidycompliancefrontend.controllers
@import uk.gov.hmrc.eusubsidycompliancefrontend.config.AppConfig
@import uk.gov.hmrc.eusubsidycompliancefrontend.models.types.UndertakingName
@import uk.gov.hmrc.eusubsidycompliancefrontend.models.BusinessEntity
@import uk.gov.hmrc.eusubsidycompliancefrontend.controllers.routes
@import uk.gov.hmrc.eusubsidycompliancefrontend.views.html.helpers.{H1, P}

@import uk.gov.hmrc.hmrcfrontend.views.html.components._
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.addtoalist.ListItem
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.addtoalist.ItemType

@this(
  layout: Layout,
  formHelper: FormWithCSRF,
  button: components.Button,
  govukErrorSummary: GovukErrorSummary,
  govukRadios : GovukRadios,
  govukSummaryList: GovukSummaryList,
  hmrcAddToAList : HmrcAddToAList
)

@(form: Form[_], businessEntity: List[BusinessEntity])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)
@key = @{"addBusiness"}
@titleKey = @{messages(s"$key.title")}

@layout(
  pageTitle = Some(titleKey),
  backLinkEnabled = true,
  backLink = Some(controllers.routes.AccountController.getAccountPage().url),
  hasErrors = form.hasErrors
) {

  @formHelper(action = controllers.routes.BusinessEntityController.postAddBusinessEntity) {
    @form.errors.map { err =>
      @govukErrorSummary(ErrorSummary(
        errorList = Seq(
          ErrorLink(
            href = Some(s"#${err.key}"),
            content = Text(s"${messages(err.key++"." ++err.message)}")
          )
        ),
        title = Text(messages("common.error.summary.title"))
      ))
    }

    @{H1(titleKey)}
      
    @if(businessEntity.length == 1){
      @{P(messages(s"$key.empty.p1"), Some("govuk-body govuk-!-margin-bottom-8"))}
    }
    
    @if(businessEntity.length > 1){
      <dl class="govuk-summary-list">
        @businessEntity.filter(a => !a.leadEORI).map { b => 
            <div class="govuk-summary-list__row govuk-summary-list__row-nobold">
                <dt class="govuk-summary-list__key">
                  @b.businessEntityIdentifier
                </dt>
                <dd class="govuk-summary-list__actions">
                  <a class="govuk-link" href="@routes.BusinessEntityController.getRemoveBusinessEntity(b.businessEntityIdentifier).toString">
                    <span aria-hidden="true">@messages("common.remove")</span>
                    <span class="govuk-visually-hidden">@messages("common.remove") @b.businessEntityIdentifier</span>
                  </a>
                </dd>
            </div>
        }
      </dl>
    }

      


    @defining(
      businessEntity.length match {
        case x if x > 1 => messages("addBusiness.businesses-added.legend")
        case _ => messages("addBusiness.legend")
      }
    ) { case (addLegend) =>
      @govukRadios(Radios(
          classes = "govuk-radios--inline",
          errorMessage = if(form.hasErrors) {Some(ErrorMessage(
              content = Text(messages("addBusiness.error.required"))
          ))} else None,
          fieldset = Some(Fieldset(
              legend = Some(Legend(
                  content = if(businessEntity.length > 1){Text(messages("addBusiness.businesses-added.legend"))}else{Text(messages("addBusiness.legend"))},
                  classes = "govuk-fieldset__legend--m",
                  isPageHeading = false
              ))
          )),
          hint = Some(Hint(
            content = Text(messages(s"$key.hint"))
          )),
          idPrefix = Some("addBusiness"),
          name = "addBusiness",
          items = Seq(
              RadioItem(
                  content = Text(messages("common.yes")),
                  value = Some("true"),
                  checked = form.data.exists(_._2 == "true")
              ),
              RadioItem(
                  content = Text(messages("common.no")),
                  value = Some("false"),
                  checked = form.data.exists(_._2 == "false")
              )
          )
      ))
    }

    @P(messages(s"$key.p2"))

    @button("common.continue")
  }
}
