@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.eusubsidycompliancefrontend.controllers
@import uk.gov.hmrc.eusubsidycompliancefrontend.config.AppConfig
@import uk.gov.hmrc.eusubsidycompliancefrontend.models.types.UndertakingName
@import uk.gov.hmrc.eusubsidycompliancefrontend.models.BusinessEntity
@import uk.gov.hmrc.eusubsidycompliancefrontend.controllers.routes
@import uk.gov.hmrc.eusubsidycompliancefrontend.views.html.helpers.{H1, P}

@this(
  layout: Layout,
  formHelper: FormWithCSRF,
  button: components.Button,
  govukErrorSummary: GovukErrorSummary,
  govukRadios : GovukRadios,
  govukSummaryList: GovukSummaryList
)

@(form: Form[_], name: UndertakingName, businessEntity: List[BusinessEntity])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)
@titleKey = @{if(businessEntity.length > 1) "addBusiness.businesses-added.title" else "addBusiness.empty.title" }

@layout(
  pageTitle = Some(messages(titleKey, name.toString)),
  hasErrors = form.hasErrors
) {

  @formHelper(action = controllers.routes.BusinessEntityController.postAddBusinessEntity) {
    @form.errors.map { err =>
      @govukErrorSummary(ErrorSummary(
        errorList = Seq(
          ErrorLink(
            href = Some(s"#${err.key}"),
            content = Text(s"${messages(err.key++"." ++err.message, name.toString)}")
          )
        ),
        title = Text(messages("common.error.summary.title"))
      ))
    }

    @{H1(messages(titleKey, name.toString))}

    @if(businessEntity.length == 1){
      @{P(messages("addBusiness.p1"))}
      @{P(messages("addBusiness.p2"))}
      @{P(messages("addBusiness.p3"))}
      @{P(messages("addBusiness.p4"))}
    }

    @{govukSummaryList(SummaryList(
      classes = "summary-list-no-value",
      rows = businessEntity.filter(a => !a.leadEORI).map(b => SummaryListRow(
        key = Key(content = Text(b.businessEntityIdentifier)),
        actions = Some(Actions(
          items = Seq(
            ActionItem(
              href = routes.BusinessEntityController.editBusinessEntity(b.businessEntityIdentifier).toString,
              content = HtmlContent(s"<span aria-hidden='true'>${messages("common.change")}</span>"),
              visuallyHiddenText = Some(messages("common.change") + " " + messages(""))
            ),
            ActionItem(
              href = routes.BusinessEntityController.getRemoveBusinessEntity(b.businessEntityIdentifier).toString,
              content = HtmlContent(s"<span aria-hidden='true'>${messages("common.remove")}</span>"),
              visuallyHiddenText = Some(messages("common.remove") + " " + messages(""))
            )
          )
        ))
      ))
    ))}
    @defining(
      businessEntity.length match {
        case x if x > 1 => messages("addBusiness.businesses-added.legend")
        case _ => messages("addBusiness.legend", name.toString)
      }
    ) { case (addLegend) =>
      @govukRadios(Radios(
          classes = "govuk-radios--inline",
          errorMessage = if(form.hasErrors) {Some(ErrorMessage(
              content = Text(messages("addBusiness.error.required", name.toString))
          ))} else None,
          fieldset = Some(Fieldset(
              legend = Some(Legend(
                  content = Text(addLegend),
                  classes = "govuk-fieldset__legend--m",
                  isPageHeading = false
              ))
          )),
          hint = Some(Hint(
            content = Text(messages("addBusiness.businesses-added.hint"))
          )),
          idPrefix = Some("addBusiness"),
          name = "addBusiness",
          items = Seq(
              RadioItem(
                  content = Text(messages("common.yes")),
                  value = Some("true"),
                  checked = form.data.exists(_._2 == "true")
              ),
              RadioItem(
                  content = Text(messages("common.no")),
                  value = Some("false"),
                  checked = form.data.exists(_._2 == "false")
              )
          )
      ))
    }

    <p class="govuk-body"><strong>@messages("addBusiness.businesses-added.p1")</strong></p>

    @button("common.continue")
  }
}
